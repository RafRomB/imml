# This workflow will install Python dependencies and run tests with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: CI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  UV_SYSTEM_PYTHON: 1

jobs:
  build:
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: ${{matrix.os}}
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.22"
        python-version: ${{ matrix.python-version }}
        enable-cache: true
    - name: Install dependencies
      run: |
        uv pip install .
    - name: Install tests
      run: |
        uv pip install ".[tests]"
    - name: Test base
      run: |
        uv run pytest --cov=imml
    - name: Test linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt install libtirpc-dev #needed for rpy2
        sudo apt install r-base r-base-dev octave octave-control octave-statistics -y
        sudo Rscript -e "install.packages(c('nnTensor', 'SNFtool'))"
    - name: Test windows
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force; `
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; `
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        choco install octave r.project
        Rscript -e "install.packages(c('nnTensor', 'SNFtool'), repos='http://cran.r-project.org')"
        $octaveRoot = "C:\ProgramData\chocolatey\lib\octave"
        if (-not (Test-Path $octaveRoot)) {
          throw "Octave root directory not found at $octaveRoot"
        }
    
        # Look for bin folder inside tools or any subdirectory
        $octaveBin = Get-ChildItem -Path $octaveRoot -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq "bin" } | Select-Object -First 1 -ExpandProperty FullName
    
        # Fallback: try known default path
        if (-not $octaveBin) {
          $octaveBin = "C:\ProgramData\chocolatey\lib\octave\tools\Octave-*\bin"
          $octaveBin = Get-ChildItem -Path "C:\ProgramData\chocolatey\lib\octave\tools" -Directory -ErrorAction SilentlyContinue | ForEach-Object { Join-Path $_.FullName "bin" } | Where-Object { Test-Path $_ } | Select-Object -First 1
        }
    
        # Fallback: check if octave-cli.exe is already on PATH
        if (-not $octaveBin) {
          $octExe = where.exe octave-cli.exe 2>$null
          if ($octExe) {
            Write-Host "octave-cli.exe is already on PATH: $octExe"
          } else {
            throw "Octave bin directory not found and octave-cli.exe not on PATH!"
          }
        } else {
          Write-Host "Adding $octaveBin to PATH"
          $env:PATH = "$octaveBin;$env:PATH"
        }
        octave-cli.exe --eval "pkg install -forge control; pkg install -forge statistics; pkg load control; pkg load statistics; ver"
    - name: Test mac
      if: runner.os == 'macOS'
      run: |
        brew install gcc
        brew install octave r
        Rscript -e "install.packages(c('nnTensor', 'SNFtool'), repos='http://cran.r-project.org')"
        octave --eval "pkg install -forge control; pkg install -forge statistics; pkg load control; pkg load statistics; ver"
    - name: Test r
      run: |
        uv pip install ".[r]"
        uv run pytest --cov=imml
    - name: Test matlab
      run: |
        uv pip install ".[matlab]"
        uv run pytest --cov=imml
    - name: Test deep
      run: |
        uv pip install ".[deep]"
        uv run pytest --cov=imml --cov-report=term --cov-report json
    - name: Test docs
      run: |
        uv pip install ".[docs]";
    - name: Upload coverage reports to Codecov
      if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: ocbe-uio/imml