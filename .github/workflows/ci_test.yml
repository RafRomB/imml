# This workflow will install Python dependencies and run tests with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: CI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  UV_SYSTEM_PYTHON: 1

jobs:
  build:
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: ${{matrix.os}}
    continue-on-error: true
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ["3.13"]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.22"
        python-version: ${{ matrix.python-version }}
        enable-cache: true
    - name: Install dependencies
      run: |
        uv pip install .
    - name: Install tests
      run: |
        uv pip install ".[tests]"
    - name: Test linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt install libtirpc-dev #needed for rpy2
        sudo apt install r-base r-base-dev octave octave-control octave-statistics -y
        sudo Rscript -e "install.packages(c('nnTensor', 'SNFtool'))"
    - name: ‚öôÔ∏è Install Octave and Configure Environment
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        # 1. Install Octave via Chocolatey
        Write-Host "Installing Octave via Chocolatey..."
        choco install octave -y | Out-Null
        
        # 2. Find Octave's executable directory (often needed when choco doesn't update PATH immediately)
        $octavePath = Join-Path -Path (Get-Command octave.exe).Source -ChildPath ".."
        Write-Host "Found Octave Path: $octavePath"
    
        # 3. Define the reliable 'tar.exe' path from Git (Fixes the archive unpack error)
        $gitBinPath = "C:\Program Files\Git\usr\bin"
        
        # 4. CRITICAL FIX: Write the updated PATH to the $GITHUB_ENV file
        # Ensure both the Octave bin directory and the Git bin directory are prepended.
        # $env:PATH ensures all existing paths are kept.
        # The output format MUST be `NAME=value` on a new line.
        
        # Construct the full new PATH string
        $newPath = "$octavePath;$gitBinPath;$env:PATH"
        
        # Write the PATH to the $GITHUB_ENV file
        "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding UTF8 -Append

    # ------------------------------------------------------------------
    # This step runs in a NEW shell instance with the fully corrected PATH
    # ------------------------------------------------------------------
    - name: üì¶ Install and Verify Octave Packages
      if: runner.os == 'Windows'
      shell: cmd # Use cmd for cleaner 'octave' command execution
      run: |
        REM Verify Octave is now recognized
        where octave
        
        REM Install packages (control and statistics)
        octave --eval "pkg install -forge control; pkg install -forge statistics; disp('Packages installed successfully.')"
        
        REM Load and verify
        octave --eval "pkg load control; pkg load statistics; pkg list; ver"
    - name: Test mac
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install gcc
        brew install octave r
        octave --eval "pkg install -forge control; pkg install -forge statistics; pkg load control; pkg load statistics; ver"
        Rscript -e "install.packages(c('nnTensor', 'SNFtool'), repos='http://cran.r-project.org')"
    - name: Test r
      run: |
        uv pip install ".[r]"
        uv run pytest --cov=imml
    - name: Test matlab
      run: |
        uv pip install ".[matlab]"
        uv run pytest --cov=imml
    - name: Test deep
      run: |
        uv pip install ".[deep]"
        uv run pytest --cov=imml --cov-report=term --cov-report json
    - name: Test docs
      run: |
        uv pip install ".[docs]";
    - name: Upload coverage reports to Codecov
      if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: ocbe-uio/imml